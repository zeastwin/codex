<UserControl x:Class="EW_Assistant.Views.Reports.ReportsCenterView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:md="clr-namespace:MdXaml;assembly=MdXaml"
             xmlns:reports="clr-namespace:EW_Assistant.Domain.Reports"
             mc:Ignorable="d"
             d:DesignHeight="720"
             d:DesignWidth="1200"
             Background="#F3F4F6"
             FontFamily="Microsoft YaHei UI, Microsoft YaHei"
             FontSize="14">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <Style x:Key="PillButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="36"/>
            <Setter Property="MinWidth" Value="132"/>
            <Setter Property="Margin" Value="0,0,12,0"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="Background" Value="#F3F6FF"/>
            <Setter Property="Foreground" Value="#1F2937"/>
            <Setter Property="BorderBrush" Value="#CBD5E1"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                            CornerRadius="18"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}">
                            <ContentPresenter HorizontalAlignment="Center"
                                          VerticalAlignment="Center"
                                          Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#E1E9FF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#90A4F4"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#CBD7FF"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#6B82F3"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#12000000"
                                  BlurRadius="12"
                                  ShadowDepth="2"
                                  Opacity="0.28"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 细窄、低存在感的滚动条样式（本控件内所有 ScrollBar 生效） -->
        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Grid Background="Transparent">
                            <Track x:Name="PART_Track" IsDirectionReversed="True">
                                <!-- 隐藏上下/左右按钮，只保留拖动条 -->
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="{x:Static ScrollBar.LineUpCommand}"
                                              Visibility="Collapsed"/>
                                </Track.DecreaseRepeatButton>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="{x:Static ScrollBar.LineDownCommand}"
                                              Visibility="Collapsed"/>
                                </Track.IncreaseRepeatButton>

                                <Track.Thumb>
                                    <Thumb x:Name="Thumb" Background="#D1D5DB">
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="Thumb">
                                                <Border CornerRadius="3"
                                                    Background="{TemplateBinding Background}"/>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <!-- 竖向：控制“粗细”为 6 -->
                            <Trigger Property="Orientation" Value="Vertical">
                                <Setter TargetName="PART_Track" Property="Width" Value="6"/>
                                <Setter TargetName="Thumb" Property="Width" Value="6"/>
                            </Trigger>

                            <!-- 横向：控制“粗细”为 6 -->
                            <Trigger Property="Orientation" Value="Horizontal">
                                <Setter TargetName="PART_Track" Property="Height" Value="6"/>
                                <Setter TargetName="Thumb" Property="Height" Value="6"/>
                            </Trigger>

                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Thumb" Property="Background" Value="#9CA3AF"/>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Thumb" Property="Background" Value="Transparent"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 顶部报表类型选择 -->
        <Border Grid.Row="0"
                Background="#F8FAFC"
                BorderBrush="#E5E7EB"
                BorderThickness="1"
                CornerRadius="12"
                Padding="12"
                Margin="0,0,0,10">
            <DockPanel LastChildFill="False">
                <TextBlock Text="报表类型"
                           VerticalAlignment="Center"
                           Foreground="#4B5563"
                           FontWeight="SemiBold"
                           Margin="0,0,12,0"/>
                <WrapPanel DockPanel.Dock="Left">
                    <Button Content="当日产能报表"
                            Click="DailyProdButton_Click">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource PillButtonStyle}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentReportType}" Value="{x:Static reports:ReportType.DailyProd}">
                                        <Setter Property="Background" Value="#E0E7FF"/>
                                        <Setter Property="BorderBrush" Value="#818CF8"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    <Button Content="产能周报"
                            Click="WeeklyProdButton_Click">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource PillButtonStyle}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentReportType}" Value="{x:Static reports:ReportType.WeeklyProd}">
                                        <Setter Property="Background" Value="#E0E7FF"/>
                                        <Setter Property="BorderBrush" Value="#818CF8"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    <Button Content="当日报警报表"
                            Click="DailyAlarmButton_Click">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource PillButtonStyle}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentReportType}" Value="{x:Static reports:ReportType.DailyAlarm}">
                                        <Setter Property="Background" Value="#E0E7FF"/>
                                        <Setter Property="BorderBrush" Value="#818CF8"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    <Button Content="报警周报"
                            Click="WeeklyAlarmButton_Click">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource PillButtonStyle}">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentReportType}" Value="{x:Static reports:ReportType.WeeklyAlarm}">
                                        <Setter Property="Background" Value="#E0E7FF"/>
                                        <Setter Property="BorderBrush" Value="#818CF8"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </WrapPanel>
                <StackPanel DockPanel.Dock="Right"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <TextBlock Text="{Binding CurrentReportTypeName}"
                               VerticalAlignment="Center"
                               Foreground="#111827"
                               FontSize="13"
                               FontWeight="SemiBold"
                               Margin="12,0,0,0"/>
                    <TextBlock Text="生成中..."
                               VerticalAlignment="Center"
                               Foreground="#DC2626"
                               FontWeight="SemiBold"
                               FontSize="12"
                               Margin="8,0,0,0"
                               Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- 主体：左侧列表 + 右侧 Markdown 预览 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1.2*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Margin="0,0,10,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,8">
                        <TextBlock Text="报表列表"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="#0B1220"/>
                    </DockPanel>

                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding Reports}"
                             SelectedItem="{Binding SelectedReport, Mode=TwoWay}"
                             PreviewMouseWheel="ReportList_PreviewMouseWheel"
                             BorderThickness="0"
                             Background="Transparent"
                             Padding="0"
                             FontSize="14"
                             ScrollViewer.VerticalScrollBarVisibility="Auto">
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type reports:ReportInfo}">
                                <StackPanel>
                                    <TextBlock Text="{Binding Title}"
                                               FontWeight="SemiBold"
                                               Foreground="#111827"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                        <TextBlock Text="{Binding DateLabel, StringFormat=日期：{0}}"
                                                   Foreground="#4B5563"
                                                   FontSize="12"/>
                                        <TextBlock Text=" · "
                                                   Foreground="#9CA3AF"
                                                   FontSize="12"
                                                   Margin="6,0"/>
                                        <TextBlock Text="{Binding GeneratedAt, StringFormat=更新：{0:yyyy-MM-dd HH:mm}}"
                                                   Foreground="#4B5563"
                                                   FontSize="12"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                        <TextBlock Text="{Binding FileSizeText, StringFormat=大小：{0}}"
                                                   Foreground="#6B7280"
                                                   FontSize="12"/>
                                        <TextBlock Text=" · "
                                                   Foreground="#9CA3AF"
                                                   FontSize="12"
                                                   Margin="6,0"/>
                                        <TextBlock Text="{Binding FileName, StringFormat=文件：{0}}"
                                                   Foreground="#6B7280"
                                                   FontSize="12"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="8,6"/>
                                <Setter Property="Margin" Value="0,2,0,2"/>
                                <Setter Property="Background" Value="#F9FAFB"/>
                                <Setter Property="BorderBrush" Value="#E5E7EB"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border x:Name="Bd"
                                                    Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="10">
                                                <ContentPresenter VerticalAlignment="Center" Margin="8,4"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bd" Property="Background" Value="#EEF2FF"/>
                                                    <Setter TargetName="Bd" Property="BorderBrush" Value="#C7D2FE"/>
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="Bd" Property="Background" Value="#E0E7FF"/>
                                                    <Setter TargetName="Bd" Property="BorderBrush" Value="#818CF8"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </Grid>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource CardBorderStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" VerticalAlignment="Center" Margin="0,0,0,6">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Vertical">
                            <TextBlock Text="{Binding SelectedReport.Title, TargetNullValue=报表预览}"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="#0B1220"/>
                            <TextBlock Text="{Binding SelectedReport.DateLabel, TargetNullValue=请选择左侧报表后预览}"
                                       FontSize="12"
                                       Foreground="#6B7280"
                                       Margin="0,2,0,0"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="打开所在文件夹"
                                    Click="OpenFolderButton_Click">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource PillButtonStyle}">
                                        <Setter Property="Margin" Value="0,0,8,0"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedReport}" Value="{x:Null}">
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Setter Property="Opacity" Value="0.6"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <Button Content="导出 Markdown"
                                    Click="ExportButton_Click">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource PillButtonStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedReport}" Value="{x:Null}">
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Setter Property="Opacity" Value="0.6"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </Grid>

                    <md:MarkdownScrollViewer Grid.Row="1"
                                             Markdown="{Binding PreviewMarkdown}"
                                             PreviewMouseWheel="PreviewScrollViewer_PreviewMouseWheel"
                                             Background="White"
                                             BorderThickness="0"
                                             Padding="0,0,8,4"
                                             VerticalScrollBarVisibility="Auto"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
