<UserControl x:Class="EW_Assistant.Views.AIAssistantView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:md="clr-namespace:MdXaml;assembly=MdXaml"
             mc:Ignorable="d" d:DesignHeight="600" d:DesignWidth="900"
             Background="#F6F7FB">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <SolidColorBrush x:Key="UserBubbleBrush" Color="#2563EB"/>
        <SolidColorBrush x:Key="UserBubbleText"  Color="#FFFFFF"/>
        <SolidColorBrush x:Key="BotBubbleBrush"  Color="#F9F9F9"/>
        <SolidColorBrush x:Key="BotBubbleText"   Color="#0B1220"/>
        <SolidColorBrush x:Key="Divider"         Color="#E6E8EF"/>
        <Style x:Key="IconGhostButton" TargetType="Button">
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="#CBD5E1"/>
            <Setter Property="BorderThickness" Value="0.8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="14">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#F1F5F9"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#94A3B8"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#E2E8F0"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#64748B"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ChatListItemNoHoverStyle" TargetType="ListBoxItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="10 6"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border Background="Transparent" SnapsToDevicePixels="True" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="InputBoxStyle" TargetType="TextBox">
            <Setter Property="BorderBrush" Value="#D5DAE5"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ScrollViewer x:Name="PART_ContentHost" Margin="0"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="ProgressItemTemplate">
            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                <TextBlock FontSize="14" Margin="0,0,6,0">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Text" Value="•"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Status}" Value="Done">
                                    <Setter Property="Text" Value="✅"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Status}" Value="Running">
                                    <Setter Property="Text" Value="⏳"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Status}" Value="Error">
                                    <Setter Property="Text" Value="⚠️"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
                <TextBlock FontSize="14" Text="{Binding Title}"/>
                <TextBlock FontSize="12" Foreground="#60646C" Text="{Binding DurationText}" Margin="6,0,0,0"/>
            </StackPanel>
        </DataTemplate>

        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="Background" Value="#111827"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#111827"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="18,10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"
                                              Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#374151"/>
                                <Setter TargetName="Bd" Property="BorderBrush"  Value="#374151"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button">
            <Setter Property="Background" Value="#F9F9F9"/>
            <Setter Property="Foreground" Value="#111827"/>
            <Setter Property="BorderBrush" Value="#D1D5DB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"
                                              Margin="{TemplateBinding Padding}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#4F46E5"/>
                                <Setter TargetName="Bd" Property="BorderBrush"  Value="#4F46E5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 气泡模板（已集成“流式轻文本 → 完成Markdown”切换） -->
        <DataTemplate x:Key="MessageTemplate">
            <Grid x:Name="MessageRoot" Background="Transparent">
                <Border x:Name="Bubble"
                        MaxWidth="860" Padding="12"
                        CornerRadius="16"
                        Background="{StaticResource BotBubbleBrush}"
                        HorizontalAlignment="Left"
                        BorderBrush="#EAEAF1" BorderThickness="1"
                        SnapsToDevicePixels="True">

                    <!-- 两层：上层流式 TextBlock，下层最终 MdXaml -->
                    <Grid>
                        <!-- 流式阶段：轻量文本（不解析 Markdown） -->
                        <TextBlock x:Name="StreamView"
                                   Text="{Binding StreamText}"
                                   TextWrapping="Wrap"
                                   Visibility="Visible"
                                   FontSize="14"
                                   Foreground="{StaticResource BotBubbleText}"
                                   xml:space="preserve"
                                   FontFamily="Consolas, 'Microsoft YaHei UI', 'Microsoft YaHei', 'Noto Sans CJK SC'" />

                        <!-- 完成后：MdXaml 渲染 Markdown -->
                        <md:MarkdownScrollViewer x:Name="Md"
                                                 Background="Transparent"
                                                 BorderThickness="0"
                                                 Markdown="{Binding Markdown}"
                                                 TextElement.Foreground="{StaticResource BotBubbleText}"
                                                 IsSelectionEnabled="True"
                                                 VerticalScrollBarVisibility="Disabled"
                                                 HorizontalScrollBarVisibility="Disabled"
                                                 Visibility="Collapsed"/>
                    </Grid>
                </Border>

                <!-- 悬浮分享按钮（仅机器人消息显示） -->
                <Button x:Name="ShareButton"
                        Style="{StaticResource IconGhostButton}"
                        Content=""
                        FontFamily="Segoe MDL2 Assets"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Bottom"
                        Margin="0,0,2,2"
                        Visibility="Collapsed"
                        Click="ShareButton_Click"
                        Foreground="#0F172A"
                        Tag="{Binding}"
                        Panel.ZIndex="2"/>
            </Grid>

            <DataTemplate.Triggers>
                <!-- 完成时：隐藏流式 TextBlock，显示 MdXaml -->
                <DataTrigger Binding="{Binding IsFinal}" Value="True">
                    <Setter TargetName="StreamView" Property="UIElement.Visibility" Value="Collapsed"/>
                    <Setter TargetName="Md" Property="UIElement.Visibility" Value="Visible"/>
                </DataTrigger>

                <!-- 用户消息样式（两套视图颜色保持一致） -->
                <DataTrigger Binding="{Binding IsUser}" Value="True">
                    <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Right"/>
                    <Setter TargetName="Bubble" Property="Background" Value="{StaticResource UserBubbleBrush}"/>
                    <Setter TargetName="Bubble" Property="BorderThickness" Value="0"/>
                    <Setter TargetName="Md" Property="TextElement.Foreground" Value="{StaticResource UserBubbleText}"/>
                    <Setter TargetName="StreamView" Property="TextElement.Foreground" Value="{StaticResource UserBubbleText}"/>
                </DataTrigger>

                <!-- 仅机器人消息悬停时展示分享按钮 -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsUser}" Value="False"/>
                        <Condition Binding="{Binding IsMouseOver, ElementName=MessageRoot}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="ShareButton" Property="UIElement.Visibility" Value="Visible"/>
                </MultiDataTrigger>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsUser}" Value="False"/>
                        <Condition Binding="{Binding IsMouseOver, ElementName=ShareButton}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter TargetName="ShareButton" Property="UIElement.Visibility" Value="Visible"/>
                </MultiDataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </UserControl.Resources>

    <!-- 主容器：上=聊天卡；下=输入卡 -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 聊天卡 -->
        <Border Grid.Row="0" Margin="16,16,16,8" Background="White" CornerRadius="16">
            <Border.Effect>
                <DropShadowEffect Color="#1A000000" BlurRadius="18" ShadowDepth="2" Opacity="0.35"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <DockPanel Grid.Row="0" LastChildFill="False" Margin="16,14,16,8">
                    <TextBlock Text="AI 助手" FontSize="18" FontWeight="SemiBold" Foreground="#0B1220"
                               DockPanel.Dock="Left" VerticalAlignment="Center"/>
                </DockPanel>
                <Border Grid.Row="0" Height="1" Background="#EEF2F7" VerticalAlignment="Bottom"/>

                <Border Grid.Row="1" Background="Transparent" Padding="16">
                    <!-- 关键：像素滚动 + 虚拟化 -->
                    <ListBox x:Name="ChatList"
                             ItemsSource="{Binding Messages, RelativeSource={RelativeSource AncestorType=UserControl}}"
                             Background="Transparent" BorderThickness="0"
                             ItemTemplate="{StaticResource MessageTemplate}"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             ScrollViewer.CanContentScroll="True"
                             PreviewMouseWheel="ChatList_PreviewMouseWheel"
                             VirtualizingPanel.IsVirtualizing="True"
                             VirtualizingPanel.VirtualizationMode="Recycling"
                             VirtualizingPanel.ScrollUnit="Pixel"
                             VirtualizingPanel.CacheLength="1"
                             VirtualizingPanel.CacheLengthUnit="Page">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem" BasedOn="{StaticResource ChatListItemNoHoverStyle}"/>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                    </ListBox>
                </Border>

                <Border Grid.RowSpan="2"
                        HorizontalAlignment="Right" VerticalAlignment="Top"
                        Margin="16"
                        Padding="14"
                        Background="#E8F3FF" BorderBrush="#CFE7FF" BorderThickness="1"
                        CornerRadius="12"
                        Visibility="{Binding IsProgressVisible, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVis}}">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="14" ShadowDepth="0" Opacity="0.16"/>
                    </Border.Effect>
                    <StackPanel>
                        <TextBlock Text="进度" FontWeight="Bold" Foreground="#0B1220" />
                        <ItemsControl ItemsSource="{Binding ProgressItems, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                      ItemTemplate="{StaticResource ProgressItemTemplate}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <TextBlock Text="⏳" Margin="0,0,6,0"/>
                            <TextBlock>
                                <Run Text="正在执行："/>
                                <Run Text="{Binding CurrentRunningTitle, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </TextBlock>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- 输入卡（新增：顶部快捷按钮栏） -->
        <Border Grid.Row="1" Margin="16,0,16,16" Background="White" CornerRadius="16" Padding="12,12,16,16">
            <Border.Effect>
                <DropShadowEffect Color="#1A000000" BlurRadius="18" ShadowDepth="2" Opacity="0.35"/>
            </Border.Effect>

            <Grid>
                <!-- 新增：行定义，Row0=快捷栏，Row1=原来的输入行 -->
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 快捷按钮栏 -->
                <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,8">
                    <WrapPanel DockPanel.Dock="Left" ItemHeight="32" ItemWidth="Auto">
                        <Button x:Name="QuickReportBtn"
                                Style="{StaticResource SecondaryButton}"
                                Padding="14,6"
                                Click="QuickReportBtn_Click"
                                Content="当日产能报表"/>
                        <Button x:Name="QuickWeeklyReportBtn"
                                Style="{StaticResource SecondaryButton}"
                                Padding="14,6"
                                Click="QuickWeeklyReportBtn_Click"
                                Content="产能周报"/>
                        <Button x:Name="QuickAlarmReportBtn"
                                Style="{StaticResource SecondaryButton}"
                                Padding="14,6"
                                Click="QuickAlarmReportBtn_Click"
                                Content="当日报警报表"/>
                        <Button x:Name="QuickWeeklyAlarmBtn"
                                Style="{StaticResource SecondaryButton}"
                                Padding="14,6"
                                Click="QuickWeeklyAlarmBtn_Click"
                                Content="报警周报"/>
                        <Button x:Name="BtnLowYield"
                                Style="{StaticResource SecondaryButton}"
                                Padding="14,6"
                                Click="BtnLowYield_Click"
                                Content="低良率扫描"/>
                    </WrapPanel>
                </DockPanel>

                <!-- 原有输入行 -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox x:Name="InputBox"
                             Style="{StaticResource InputBoxStyle}"
                             Grid.Column="0" MinHeight="44"
                             AcceptsReturn="True" TextWrapping="Wrap"
                             VerticalScrollBarVisibility="Auto"
                             Text="{Binding InputText, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}"
                             PreviewKeyDown="InputBox_PreviewKeyDown" />

                    <Button x:Name="SendBtn" Grid.Column="1" Margin="8,0,0,0"
                            MinWidth="88" Content="发送"
                            Click="SendBtn_Click"
                            Style="{StaticResource PrimaryButton}"/>

                    <Button x:Name="StopBtn" Grid.Column="2" Margin="8,0,0,0"
                            Content="停止" Click="StopBtn_Click"
                            Style="{StaticResource SecondaryButton}"/>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
